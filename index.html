<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Plano Interactivo Mirador</title>
  <style>
    :root {
      /* Tamaños base de fuente */
      --font-body: 16px;
      --font-small: 14px;
      --font-title: 20px;
      --font-title-big: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      font-size: var(--font-body);
      color: #2c3e50;
    }

    /* CONTENEDOR PRINCIPAL
       Mobile first: SIEMPRE columna (plano arriba, info abajo)
    */
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;          /* ocupamos toda la pantalla */
    }

    /* BLOQUE SUPERIOR: PLANO */
    .mapa-container {
      flex: 0 0 75vh;         /* ~3/4 de la altura de la pantalla */
      max-height: 75vh;
      overflow: auto;         /* scroll si hace falta */
      background: #ffffff;
      border-bottom: 1px solid #ddd;
    }

    .mapa-container object {
      width: 100%;
      height: 100%;
      display: block;
      border: none;
    }

    /* BLOQUE INFERIOR: PANEL DE INFORMACIÓN */
    .panel-info {
      flex: 1 0 25vh;         /* ~1/4 de la altura de la pantalla */
      min-height: 25vh;
      padding: 10px 12px;
      background: #ffffff;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.08);
      overflow-y: auto;
    }

    .panel-info h2 {
      margin: 0 0 6px 0;
      font-size: var(--font-title-big);
      color: #2c3e50;
    }

    .panel-subtitulo {
      margin: 0 0 10px 0;
      font-size: var(--font-small);
      color: #7f8c8d;
    }

    /* GRID DE CAMPOS DENTRO DEL PANEL
       Aquí se colocan todos los <div class="campo"> que genera JS.
    */
    #infoLote {
      display: grid;
      grid-template-columns: 1fr 1fr; /* hasta 2 columnas */
      column-gap: 12px;
      row-gap: 4px;
      font-size: var(--font-small);
    }

    /* En pantallas MUY estrechas (móviles pequeños) pasamos a 1 columna */
    @media (max-width: 400px) {
      #infoLote {
        grid-template-columns: 1fr;
      }
    }

    .campo {
      margin: 0; /* el espacio lo da el row-gap del grid */
    }

    .campo b {
      display: inline-block;
      font-weight: 600;
      color: #555;
      margin-right: 4px;
    }

    /* Estado con colores */
    .estado-disponible { color: #27ae60; font-weight: bold; }
    .estado-reservado  { color: #f1c40f; font-weight: bold; }
    .estado-vendido    { color: #e74c3c; font-weight: bold; }

    /* --------- VERSIÓN ESCRITORIO / TABLET GRANDE ---------
       A partir de 900px de ancho volvemos al diseño en 2 columnas:
       plano a la izquierda, panel a la derecha.
       Así se ve bien tanto en PC como en móvil.
    ---------------------------------------------------------*/
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
      }

      .mapa-container {
        flex: 2;
        max-height: 100vh;
        border-bottom: none;
        border-right: 1px solid #ddd;
      }

      .panel-info {
        flex: 1;
        min-height: 100vh;
        box-shadow: -2px 0 6px rgba(0,0,0,0.08);
      }

      /* En escritorio es cómodo mantener 2 columnas de datos */
      #infoLote {
        grid-template-columns: 1fr 1fr;
      }

      .panel-info h2 {
        font-size: 24px;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>

  <div class="layout">
    <!-- BLOQUE SUPERIOR: PLANO SVG -->
    <div class="mapa-container">
      <object
        id="planoSvg"
        data="El_Mirador_1.svg"
        type="image/svg+xml">
      </object>
    </div>

    <!-- BLOQUE INFERIOR: PANEL DE INFORMACIÓN DEL LOTE -->
    <div class="panel-info">
      <h2 id="tituloLote">Seleccione un lote</h2>
      <p class="panel-subtitulo">
        Haga clic en un lote del plano para ver sus detalles aquí mismo.
      </p>
      <div id="infoLote">
        <!-- Aquí se inyectan los <div class="campo"> desde JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // URL de tu Apps Script (solo lectura)
    const URL_API = "https://script.google.com/macros/s/AKfycbwmyLh86dC2fE-4mRWoaSadbtjkCU-Jcl3ZcYKN3ZdgVxo__RG0Orl7sdaxxi0JSiNR/exec";

    /**
     * Obtiene la información de un lote por su Codigo_Automatico
     */
    async function obtenerLote(codigo) {
      try {
        const url = URL_API + "?lote=" + encodeURIComponent(codigo);
        console.log("[API] Llamando a:", url);
        const res = await fetch(url);

        if (!res.ok) {
          console.error("[API] Error HTTP", res.status, res.statusText);
          return null;
        }
        const data = await res.json();
        console.log("[API] Respuesta:", data);
        return data;
      } catch (err) {
        console.error("[API] Error de red o parseo:", err);
        return null;
      }
    }

    /**
     * Pinta los datos del lote en el panel inferior
     */
    function mostrarLoteEnPanel(lote) {
      const titulo = document.getElementById("tituloLote");
      const info   = document.getElementById("infoLote");

      if (!lote || Object.keys(lote).length === 0) {
        titulo.textContent = "Lote no encontrado";
        info.innerHTML = "<div class='campo'><b>Mensaje:</b> No se encontraron datos para este lote.</div>";
        return;
      }

      titulo.textContent = "Lote " + (lote.Nombre_Lote || lote.Codigo_Automatico);

      // Determinar clase para el estado
      let claseEstado = "";
      const estado = String(lote.Estado || "").toLowerCase();
      if (estado.includes("disponible")) claseEstado = "estado-disponible";
      if (estado.includes("reservado"))  claseEstado = "estado-reservado";
      if (estado.includes("vendido"))    claseEstado = "estado-vendido";

      info.innerHTML = `
        <div class="campo"><b>Código automático:</b> ${lote.Codigo_Automatico || ""}</div>
        <div class="campo"><b>Proyecto:</b> ${lote.Proyecto || ""}</div>
        <div class="campo"><b>Manzana:</b> ${lote.Manzana || ""}</div>
        <div class="campo"><b>Nombre de lote:</b> ${lote.Nombre_Lote || ""}</div>
        <div class="campo"><b>Área (m²):</b> ${lote.Area_Lote_m2 || ""}</div>
        <div class="campo"><b>Frente (m):</b> ${lote.Frente_m || ""}</div>
        <div class="campo"><b>Derecha (m):</b> ${lote.Derecha_m || ""}</div>
        <div class="campo"><b>Izquierda (m):</b> ${lote.Izquierda_m || ""}</div>
        <div class="campo"><b>Fondo (m):</b> ${lote.Fondo_m || ""}</div>
        <div class="campo"><b>Estado:</b> <span class="${claseEstado}">${lote.Estado || ""}</span></div>
        <div class="campo"><b>Precio lista:</b> ${lote.Precio_Lista || ""}</div>
        <div class="campo"><b>Permite otro precio:</b> ${lote.Permitir_Otro_Precio || ""}</div>
        <div class="campo"><b>Ubicación:</b> ${lote.Detalles_de_Ubicación || ""}</div>
        <div class="campo"><b>Motivo no disponible:</b> ${lote.Motivo_por_qué_no_disponible || ""}</div>
        <div class="campo"><b>Estado en fase de venta:</b> ${lote.Estado_en_fase_de_venta || ""}</div>
        <div class="campo"><b>Asesor responsable:</b> ${lote.Asesor_Responsable || ""}</div>
      `;
    }

    /**
     * Conecta los clics del SVG con la API
     */
    function inicializarEventosSVG() {
      const obj = document.getElementById("planoSvg");
      if (!obj) {
        console.error("[SVG] No se encuentra el elemento #planoSvg");
        return;
      }

      console.log("[SVG] inicializarEventosSVG ejecutado");

      function conectarEventos() {
        const svgDoc = obj.contentDocument || (obj.getSVGDocument && obj.getSVGDocument());
        if (!svgDoc) {
          console.error("[SVG] No se pudo acceder a contentDocument/getSVGDocument.");
          return;
        }

        const lotes = svgDoc.querySelectorAll(".lote");
        console.log("[SVG] Lotes encontrados en el SVG:", lotes.length);

        lotes.forEach(el => {
          el.style.cursor = "pointer";
          el.addEventListener("click", async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const codigo = el.id;
            console.log("[SVG] Lote clicado:", codigo);
            const datos = await obtenerLote(codigo);
            mostrarLoteEnPanel(datos);
          });
        });

        if (!lotes.length) {
          console.warn("[SVG] Atención: no se encontró ningún elemento con class='lote'.");
        }
      }

      if (obj.contentDocument || (obj.getSVGDocument && obj.getSVGDocument())) {
        console.log("[SVG] El objeto ya tiene contentDocument, conectando eventos ahora.");
        conectarEventos();
      } else {
        console.log("[SVG] Esperando evento 'load' del <object>…");
        obj.addEventListener("load", conectarEventos, { once: true });
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      console.log("[APP] DOMContentLoaded");
      inicializarEventosSVG();
    });
  </script>

</body>
</html>
